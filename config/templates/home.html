<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.107.1/Build/Cesium/Cesium.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <link rel="shortcut icon" href="#">
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.107.1/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>
<body>

  <div style="height: 100vh;width: 100vw;position: relative;">
    <ul
      style="position: absolute;top:30px;right:50px;color:  white;background:transparent;list-style: none;z-index: 1000;padding: 14px;font-size: 25px;">
      <li id="data-lat"></li>
      <li id="data-lon"></li>
      <li id="data-height"></li>
      <li id="data-time"></li>
    </ul>
    <div style="width: 100%;" id="cesiumContainer"></div>
  </div>

  <script type="module">
    
    // convert radians to degrees
    function r2d(radians, n) {
      const num = radians * (180 / Math.PI);
      return Math.round(num * Math.pow(10, n)) / Math.pow(10, n)
    }

    // fetch live data from server
    function get_live_data() {
      const div_data_lat = document.getElementById('data-lat');
      const div_data_lon = document.getElementById('data-lon');
      const div_data_height = document.getElementById('data-height');
      const div_data_time = document.getElementById('data-time');
     
      $.ajax({
        url: "{% url 'data' %}",
        type: "GET",
        dataType: "json",
        success: (data) => {
          div_data_lat.innerHTML = `Latitude : ${data.context.lat}`;
          div_data_lon.innerHTML = `Longitude : ${data.context.lon}`;
          div_data_height.innerHTML = `Height : ${data.context.height}`;
          div_data_time.innerHTML = `UTC : ${data.context.time}`;
          // console.log(data.context);
        },
        error: (error) => {
          console.log(error);
        }
      });

    }

    // fetch data over timeline
    function get_data_buffer() {
      let data_readings;
      $.ajax({
        url: "{% url 'databuffer' %}",
        type: "GET",
        dataType: "json",
        async:false,
        success: (data) => {
          data_readings= data.context;      
        },
        error: (error) => {
          console.log(error);
        }
      });
      return data_readings
    }

    // Cesium Viewer Setup
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4ZjM0YTMzOC04NTIwLTQwMTItYTg5Ni0wOTFhNjlkZTJiYzIiLCJpZCI6MTUzNzcwLCJpYXQiOjE2ODkyNjg2NjV9.JHjxyoN8RovBonODf3w6B654ZNhxvoqCbAqAsKZrxBY'
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
    });  


    // Getting Data Over Time
    const data_readings = get_data_buffer();
    const len_data = Object.keys(data_readings).length



    // Plotting data using databuffer 

    const start = Cesium.JulianDate.fromIso8601(data_readings[0].iso_string);
    const stop = Cesium.JulianDate.fromIso8601(data_readings[len_data-1].iso_string);
    
    const positionsOverTime = new Cesium.SampledPositionProperty();
    for (let i = 0; i<len_data; i++){
      const instance = data_readings[i];
      const time = Cesium.JulianDate.fromIso8601(instance.iso_string);
      const position = Cesium.Cartesian3.fromDegrees( instance.longitude,instance.latitude, instance.height*1000);
      positionsOverTime.addSample(time, position)
    }

    // Visualize the satellite with a dot and orbit.

    const orbit = viewer.entities.add({
      availability: new Cesium.TimeIntervalCollection([ new Cesium.TimeInterval({start: start, stop: stop}) ]),
      position: positionsOverTime,
      point: {pixelSize: 30, color: Cesium.Color.YELLOW },
      path: new Cesium.PathGraphics({ width: 3, color: Cesium.Color.RED})
    });

    // fetching live data from server 
    const div_data = document.getElementById('data');
    const timeID = setInterval(get_live_data, 1000);

    // Set the camera to follow the satellite 
    // viewer.trackedEntity = orbit; 

    let initialized = false;
    viewer.scene.globe.tileLoadProgressEvent.addEventListener(() => {
      if (!initialized && viewer.scene.globe.tilesLoaded === true) {
        viewer.clock.shouldAnimate = true;
        initialized = true;
        viewer.scene.camera.zoomOut(7000000);    // Wait for globe to load then zoom out 
      }
    });
    
    // setting camera to ICRF

    const scene = viewer.scene;
    const clock = viewer.clock;
    
    function icrf(scene, time) {
      if (scene.mode !== Cesium.SceneMode.SCENE3D) {return;}

      const icrfToFixed = Cesium.Transforms.computeIcrfToFixedMatrix(time);
      if (Cesium.defined(icrfToFixed)) {
        const camera = viewer.camera;
        const offset = Cesium.Cartesian3.clone(camera.position);
        const transform = Cesium.Matrix4.fromRotationTranslation(
          icrfToFixed
        );
        camera.lookAtTransform(transform, offset);
      }
    }

    function viewInICRF() {
      viewer.camera.flyHome(0);
      //clock.multiplier = 3 * 60;
      scene.postUpdate.addEventListener(icrf);

    }
    //viewInICRF();

  </script>
 </div>
</body>
</html>